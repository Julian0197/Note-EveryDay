## 执行上下文

### 执行上下文类型

1. 全局执行上下文

任何不在函数内部的都是全局执行上下文，它首先会创建一个全局的windows对象，并且设置this的值等于这个全局对象，一个程序只有一个全局执行上下文。

2. 函数执行上下文

当一个函数被调用，就会为该函数创建一个新的执行上下文，函数的执行上下文可以有任意多个

3. eval函数执行上下文

执行在eval函数中的代码会有属于他自己的执行上下文，不过eval函数不常使用，不做介绍。

### 执行上下文栈

+ JS引擎用执行上下文栈来管理执行上下文
+ 当JS执行代码，首先遇到全局代码，会创建一个全局执行上下文并压入执行栈，每当遇到一个函数调用就会为该函数创建一个新的执行上下文并压入栈顶，引擎会执行位于执行上下文栈顶的函数，当函数执行完成之后，执行上下文从栈中弹出，继续执行下一个上下文。当所有的代码都执行完毕之后，从栈中弹出全局执行上下文。

### 创建执行上下文

创建执行上下文有两个阶段：创建阶段和执行阶段

**创建阶段**

+ this的绑定

  + 在全局执行上下文中，this指向全局对象
  + 在函数执行上下文，this取决于函数如何调用。如果它被一个引用对象调用，那么 this 会被设置成那个对象，否则 this 的值被设置为全局对象或者 undefined。

+ 创建词法环境组件

  + 词法环境是一种有**标识符——变量映射**的数据结构，标识符是指变量/函数名，变量是对实际对象或原始数据的引用。

  + 词法环境内部有两个组件：**环境记录器和外部环境的引用**

    > 1. **环境记录器**是存储变量和函数声明的实际位置。
    > 2. **外部环境的引用**意味着它可以访问其父级词法环境（作用域）。

+ 创建变量环境组件
  + 变量环境也是一个词法环境，其环境记录器持有变量声明语句在执行上下文中创建的绑定关系。

**执行阶段**

此阶段会完成对变量的分配，最后执行完代码。



**简单概括执行上下文**

> 在执行JS代码之前，会先解析代码。解析之前，会创建一个全局执行上下文环境，先把代码中即将执行的变量、函数声明都拿出来，变量先赋值为undefined，函数先声明好可使用。这一步执行完了，才开始正式的执行程序。
>
> 在一个函数执行之前，也会创建一个函数执行上下文环境，跟全局执行上下文类似，不过函数执行上下文会多出this、arguments和函数的参数。