## TCP/IP网络模型有哪几层

同一设备上的进程有很多通信方式：管道、消息队列、共享内存和信号等。不同设备上的进程通信需要借助网络，因此需要一套**通用的网络协议**。

网络协议都是分层的，每一层都有各自的作用和职责，下面就是`TCP/IP网络模型`。

### 应用层

最上层，也是我们能直接接触到的，电脑手机的应用软件都是在应用层上实现的。当两个不同设备之间的应用需要通信时，应用会将应用数据传递给下一层，也就是传输层。

应用层只需要关注为用户提供应用功能，比如：HTTP、FTP、DNS、SMTP等

应用层不关心数据是如何传输的。

### 传输层

应用层数据传递给传输层，传输层为应用提供网络支持。

<img src="C:\Users\MSK\AppData\Roaming\Typora\typora-user-images\image-20221015151143494.png" alt="image-20221015151143494" style="zoom:25%;" />

传输层有两个传输协议，分别是UDP和TCP。

**TCP**全称是传输控制协议（Transmission Control Protocol），大部分应用使用的是TCP传输层协议，比如HTTP协议。TCP相比于UDP多了很多特性，比如流量控制、超时重传、拥塞控制等，这些都是为了保证数据能**可靠**的传输。

**UDP**只负责发送数据包，不保证数据包是否能抵达对方，但它实用性更好，传输销量更高。UDP如果要实现可靠的数据传输，需要把TCP的特性加在应用层上。

应用层需要传输的数据可能很大，如果直接传输不好控制，因此当传输层的数据包大小超过**MSS（TCP最大报文段长度）**，就将数据包分块，这样即使在传输过程中有分块丢失或者损坏，只需要重新发送这一个分块，不用重新发送整个数据包。在TCP协议中，将每个分块称为一个**TCP段**（TCP Segment）。

<img src="C:\Users\MSK\AppData\Roaming\Typora\typora-user-images\image-20221015151204055.png" alt="image-20221015151204055" style="zoom:25%;" />

当设备作为接收方，传输层要把数据包交给应用，但是一台设备上可能有很多应用在接受或者传输数据，因此要用一个编号将应用分开来，这个编号就是**端口**。

比如，80端口通常是Web服务器端用的，22端口通常是远程登录服务器用的。而对于浏览器中的每个标签栏都是一个独立的进程，操作系统会为这些进程分配临时端口。

传输层的报文中携带有端口号，因此接收方可以识别出该报文是发送给哪个应用。

### 网络层

传输层并不负责将一个设备传递给另一个设备。

实际场景网络错综复杂，中间有各种线路和分叉路口，如果一个设备的数据要传递给另一个，就需要选择路径和节点，而传输层的设计理念就是简单、高效、专注。

传输层可以理解为应用层传输的媒介，帮助实现应用到应用的通信，实际的传输功能交给网络层。

<img src="C:\Users\MSK\AppData\Roaming\Typora\typora-user-images\image-20221015153011197.png" alt="image-20221015153011197" style="zoom:25%;" />

网络层最常用的协议是**IP协议**（Internet Protocol），IP协议会将传输层的数据报文，再加上IP头部组装成**IP报文**，如果IP报文大小超过MTU（以太网中一般为 1500 字节）就会**再次进行分片**，得到一个即将发送到网络的IP报文。

<img src="C:\Users\MSK\AppData\Roaming\Typora\typora-user-images\image-20221015153851633.png" alt="image-20221015153851633" style="zoom:25%;" />

网络层负责将数据从一个设备传输到另一个设备，因此网络层需要能区分设备的编号。

一般用IP地址给给设备进行编号，对于IPV4协议，IP地址一共32位，分成四段（比如，192.168.100.1），每段是8位。IPV4虽然做到了设备划分，但是寻址存在困难。

因此，将IP地址分成两种意义：

+ 网络号：负责标识该IP地址属于哪个`子网`
+ 主机号：负责标识`同一子网下的不同主机`

需要配合**子网掩码**才能算出IP地址的网络号和主机号。

举个例子，比如 10.100.122.0/24，后面的`/24`表示就是 `255.255.255.0` 子网掩码，255.255.255.0 二进制是「11111111-11111111-11111111-00000000」，用/24代替255.255.255.0。

知道了子网掩码，该怎么计算出网络地址和主机地址呢？

将 10.100.122.2 和 255.255.255.0 进行**按位与运算**，就可以得到网络号，如下图：

<img src="C:\Users\MSK\AppData\Roaming\Typora\typora-user-images\image-20221015155101820.png" alt="image-20221015155101820" style="zoom:25%;" />

将 255.255.255.0 取反后与IP地址进行进行**按位与运算**，就可以得到主机号。

在寻址过程中，先匹配到相同的网络号（表示要找的是同一个子网），才会去找对应的主机。

除了寻址能力，IP协议另一个重要的作用就是**路由**。实际场景中，两台是设备之间不是通过一条网线相连，而是通过很多网关、路由器、交换机等众多网络设备连接起来的，因此会形成很多的网络路径，当数据包到达某一个网络节点，需要通过路由算法决定该走哪一条路径。

路由器寻址的工作中，就是要找到目标地址的子网，找到后进而把数据包转发给对应的网络内。

<img src="C:\Users\MSK\AppData\Roaming\Typora\typora-user-images\image-20221015155407112.png" alt="image-20221015155407112" style="zoom:25%;" />

所以，**IP协议的寻址作用就是在告诉我们去往下一个目的地该朝哪个方向走，路由则是根据[下一个目的地]选择路径。**

### 网络接口层

生成了IP头部后，接下来要将交给网络接口层，在IP头部加上**MAC头部**，并封装成**数据帧**发送到网络上。

IP头部中接收方的IP地址表示的是网络包的目的地，通过IP地址可以判断将要把数据包发到哪里，但是在以太网的世界中，不行。

电脑上的以太网接口，Wi-Fi接口，以太网交换机，路由器上的千兆、万兆以太网接口，还有网线都属于以太网。以太网是一种在局域网中，把附近的设备连接起来，使他们之间可以进行通讯的技术。

以太网在判断网络包目的地时和 IP 的方式不同，因此必须采用相匹配的方式才能在以太网中将包发往目的地，而 MAC 头部就是干这个用的，所以，在以太网进行通讯要用到 **MAC 地址**。

**MAC 头部**是以太网使用的头部，它包含了接收方和发送方的 MAC 地址等信息，我们可以通过 **ARP 协议**获取对方的 MAC 地址。

所以说，网络接口层主要为网络层提供**「链路级别」**传输的服务，**负责在以太网、WiFi 这样的底层网络上发送原始数据包，工作在网卡这个层次，使用 MAC 地址来标识网络上的设备。**

### 总结

综上所述，TCP/IP 网络通常是由上到下分成 4 层，分别是**应用层，传输层，网络层和网络接口层**。

网络接口层的传输单位是帧（frame），IP 层的传输单位是包（packet），TCP 层的传输单位是段（segment），HTTP 的传输单位则是消息或报文（message）。但这些名词并没有什么本质的区分，可以统称为数据包。

<img src="C:\Users\MSK\AppData\Roaming\Typora\typora-user-images\image-20221015161546558.png" alt="image-20221015161546558" style="zoom:25%;" />